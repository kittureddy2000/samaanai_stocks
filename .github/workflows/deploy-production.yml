name: Deploy to Production

on:
  push:
    branches: [main]

env:
  GCP_PROJECT: samaanai-prod-1009-124126
  GCP_REGION: us-central1
  BACKEND_SERVICE: trading-api
  FRONTEND_SERVICE: trading-dashboard

jobs:
  deploy-backend:
    name: Deploy Backend API
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker
      
      - name: Build and Push Docker image
        run: |
          docker build -t gcr.io/$GCP_PROJECT/$BACKEND_SERVICE:${{ github.sha }} .
          docker push gcr.io/$GCP_PROJECT/$BACKEND_SERVICE:${{ github.sha }}
      
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.BACKEND_SERVICE }}
          region: ${{ env.GCP_REGION }}
          image: gcr.io/${{ env.GCP_PROJECT }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }}
          flags: |
            --allow-unauthenticated
            --memory=512Mi
            --cpu=1
            --min-instances=1
            --max-instances=5
          env_vars: |
            ALPACA_API_KEY=${{ secrets.ALPACA_API_KEY_PROD }}
            ALPACA_SECRET_KEY=${{ secrets.ALPACA_SECRET_KEY_PROD }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            NEWS_API_KEY=${{ secrets.NEWS_API_KEY }}
      
      - name: Show Backend URL
        run: |
          echo "✅ Backend deployed to: $(gcloud run services describe $BACKEND_SERVICE --region=$GCP_REGION --format='value(status.url)')"

  deploy-frontend:
    name: Deploy Frontend Dashboard
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker
      
      - name: Get Backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE --region=$GCP_REGION --format='value(status.url)')
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
      
      - name: Update API URL in Frontend
        working-directory: dashboard
        run: |
          echo "VITE_API_URL=${{ steps.backend-url.outputs.url }}" > .env.production
      
      - name: Build and Push Docker image
        working-directory: dashboard
        run: |
          docker build -t gcr.io/$GCP_PROJECT/$FRONTEND_SERVICE:${{ github.sha }} .
          docker push gcr.io/$GCP_PROJECT/$FRONTEND_SERVICE:${{ github.sha }}
      
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.FRONTEND_SERVICE }}
          region: ${{ env.GCP_REGION }}
          image: gcr.io/${{ env.GCP_PROJECT }}/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}
          flags: |
            --allow-unauthenticated
            --memory=256Mi
            --cpu=1
            --min-instances=0
            --max-instances=3
      
      - name: Show Frontend URL
        run: |
          echo "✅ Frontend deployed to: $(gcloud run services describe $FRONTEND_SERVICE --region=$GCP_REGION --format='value(status.url)')"
