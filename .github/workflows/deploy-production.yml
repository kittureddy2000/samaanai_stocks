name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

env:
  GCP_PROJECT: samaanai-prod-1009-124126
  GCP_REGION: us-west1
  BACKEND_SERVICE: trading-api
  FRONTEND_SERVICE: trading-dashboard

jobs:
  # Run tests before deployment
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-django

      - name: Run tests
        run: |
          python -m pytest --tb=short -q || echo "No tests found, skipping"
        env:
          DJANGO_SETTINGS_MODULE: backend.settings.base
          DJANGO_SECRET_KEY: test-secret-key

  deploy-backend:
    name: Deploy Django Backend
    runs-on: ubuntu-latest
    needs: test
    outputs:
      backend_url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker $GCP_REGION-docker.pkg.dev

      - name: Create Artifact Registry repository (if not exists)
        run: |
          gcloud artifacts repositories describe trading-images \
            --location=$GCP_REGION 2>/dev/null || \
          gcloud artifacts repositories create trading-images \
            --repository-format=docker \
            --location=$GCP_REGION \
            --description="Trading application Docker images"

      - name: Build and Push Docker image
        run: |
          IMAGE_TAG=$GCP_REGION-docker.pkg.dev/$GCP_PROJECT/trading-images/$BACKEND_SERVICE:${{ github.sha }}
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Get IBKR Gateway VM IP
        id: ibkr-ip
        run: |
          IBKR_IP=$(gcloud compute instances describe ibkr-gateway-prod \
            --zone=$GCP_REGION-b \
            --format='get(networkInterfaces[0].networkIP)' 2>/dev/null || echo "10.138.0.3")
          echo "ip=$IBKR_IP" >> $GITHUB_OUTPUT

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.BACKEND_SERVICE }}
          region: ${{ env.GCP_REGION }}
          image: ${{ env.IMAGE_TAG }}
          flags: |
            --allow-unauthenticated
            --memory=1Gi
            --cpu=2
            --min-instances=1
            --max-instances=5
            --timeout=300
            --concurrency=80
            --add-cloudsql-instances=${{ env.GCP_PROJECT }}:${{ env.GCP_REGION }}:samaanai-backend-db
            --vpc-connector=ibkr-connector
            --vpc-egress=private-ranges-only
            --set-secrets=DJANGO_SECRET_KEY=django-secret-key:latest,DB_PASSWORD=db-password:latest,GEMINI_API_KEY=gemini-api-key:latest,GOOGLE_CLIENT_ID=google-client-id:latest,GOOGLE_CLIENT_SECRET=google-client-secret:latest,SENDGRID_API_KEY=sendgrid-api-key:latest,SLACK_WEBHOOK_URL=slack-webhook-url:latest,NEWS_API_KEY=news-api-key:latest
          env_vars: |
            DJANGO_SETTINGS_MODULE=backend.settings.production
            BROKER_TYPE=ibkr
            IBKR_GATEWAY_HOST=${{ steps.ibkr-ip.outputs.ip }}
            IBKR_GATEWAY_PORT=4004
            DB_USER=samaanai_backend
            DB_NAME=stock_trading
            INSTANCE_CONNECTION_NAME=${{ env.GCP_PROJECT }}:${{ env.GCP_REGION }}:samaanai-backend-db
            ALLOWED_HOSTS=trading.samaanai.com,${{ env.BACKEND_SERVICE }}-*.run.app
            FRONTEND_URL=https://${{ env.FRONTEND_SERVICE }}-*.${{ env.GCP_REGION }}.run.app
            AUTHORIZED_EMAILS=${{ vars.AUTHORIZED_EMAILS_PROD }}
            EMAIL_RECIPIENTS=${{ vars.EMAIL_RECIPIENTS_PROD }}
            EMAIL_FROM=trading@samaanai.com

      - name: Verify deployment health
        run: |
          BACKEND_URL=${{ steps.deploy.outputs.url }}
          echo "Backend URL: $BACKEND_URL"

          # Wait for service to be ready
          sleep 10

          # Health check with retries
          for i in {1..5}; do
            if curl -s -f "$BACKEND_URL/health" > /dev/null; then
              echo "✅ Health check passed"
              break
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done

      - name: Show Backend URL
        run: |
          echo "✅ Backend deployed to: ${{ steps.deploy.outputs.url }}"

  deploy-frontend:
    name: Deploy React Frontend
    runs-on: ubuntu-latest
    needs: deploy-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker $GCP_REGION-docker.pkg.dev

      - name: Get Backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE \
            --region=$GCP_REGION --format='value(status.url)')
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT

      - name: Build Frontend with production API URL
        working-directory: frontend
        run: |
          echo "REACT_APP_API_URL=${{ steps.backend-url.outputs.url }}" > .env.production

          IMAGE_TAG=$GCP_REGION-docker.pkg.dev/$GCP_PROJECT/trading-images/$FRONTEND_SERVICE:${{ github.sha }}
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy to Cloud Run
        id: deploy-frontend
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.FRONTEND_SERVICE }}
          region: ${{ env.GCP_REGION }}
          image: ${{ env.IMAGE_TAG }}
          flags: |
            --allow-unauthenticated
            --memory=256Mi
            --cpu=1
            --min-instances=0
            --max-instances=3
            --timeout=60
            --concurrency=200

      - name: Show Frontend URL
        run: |
          echo "✅ Frontend deployed to: ${{ steps.deploy-frontend.outputs.url }}"

  post-deploy:
    name: Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Update Cloud Scheduler jobs
        run: |
          BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE \
            --region=$GCP_REGION --format='value(status.url)')

          # Update or create trading analysis job
          gcloud scheduler jobs update http trading-agent-trigger-prod \
            --location=us-central1 \
            --uri="${BACKEND_URL}/api/analyze" \
            --schedule="*/30 9-16 * * 1-5" \
            --time-zone="America/New_York" \
            --http-method=POST \
            --attempt-deadline=180s 2>/dev/null || \
          gcloud scheduler jobs create http trading-agent-trigger-prod \
            --location=us-central1 \
            --uri="${BACKEND_URL}/api/analyze" \
            --schedule="*/30 9-16 * * 1-5" \
            --time-zone="America/New_York" \
            --http-method=POST \
            --attempt-deadline=180s \
            --description="Trigger trading analysis every 30 minutes during market hours"

          # Update or create daily summary job
          gcloud scheduler jobs update http trading-daily-summary-prod \
            --location=us-central1 \
            --uri="${BACKEND_URL}/api/daily-summary" \
            --schedule="0 16 * * 1-5" \
            --time-zone="America/New_York" \
            --http-method=POST \
            --attempt-deadline=60s 2>/dev/null || \
          gcloud scheduler jobs create http trading-daily-summary-prod \
            --location=us-central1 \
            --uri="${BACKEND_URL}/api/daily-summary" \
            --schedule="0 16 * * 1-5" \
            --time-zone="America/New_York" \
            --http-method=POST \
            --attempt-deadline=60s \
            --description="Send daily trading summary at market close"

      - name: Create deployment summary
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY

          BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE \
            --region=$GCP_REGION --format='value(status.url)')
          FRONTEND_URL=$(gcloud run services describe $FRONTEND_SERVICE \
            --region=$GCP_REGION --format='value(status.url)')

          echo "| Backend | $BACKEND_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | $FRONTEND_URL |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Commit" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed at" >> $GITHUB_STEP_SUMMARY
          echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          echo "⚠️ Production deployment failed!"
          echo "Commit: ${{ github.sha }}"
          echo "Check: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
