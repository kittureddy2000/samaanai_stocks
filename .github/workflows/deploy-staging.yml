name: Deploy to Staging

on:
  push:
    branches: [staging]

env:
  GCP_PROJECT: samaanai-stg-1009-124126
  GCP_REGION: us-west1
  BACKEND_SERVICE: trading-api-staging
  FRONTEND_SERVICE: trading-dashboard-staging

jobs:
  deploy-backend:
    name: Deploy Django Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker
      
      - name: Build and Push Docker image
        run: |
          docker build -t gcr.io/$GCP_PROJECT/$BACKEND_SERVICE:${{ github.sha }} .
          docker push gcr.io/$GCP_PROJECT/$BACKEND_SERVICE:${{ github.sha }}
      
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.BACKEND_SERVICE }}
          region: ${{ env.GCP_REGION }}
          image: gcr.io/${{ env.GCP_PROJECT }}/${{ env.BACKEND_SERVICE }}:${{ github.sha }}
          flags: |
            --allow-unauthenticated
            --memory=512Mi
            --cpu=1
            --min-instances=0
            --max-instances=2
            --add-cloudsql-instances=samaanai-stg-1009-124126:us-west1:samaanai-backend-staging-db
            --vpc-connector=ibkr-connector
            --vpc-egress=private-ranges-only
          env_vars: |
            DJANGO_SETTINGS_MODULE=backend.settings.production
            DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
            ALPACA_API_KEY=${{ secrets.ALPACA_API_KEY }}
            ALPACA_SECRET_KEY=${{ secrets.ALPACA_SECRET_KEY }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            NEWS_API_KEY=${{ secrets.NEWS_API_KEY }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            AUTHORIZED_EMAILS=${{ vars.AUTHORIZED_EMAILS }}
            DB_USER=samaanai_backend
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=stock_trading
            INSTANCE_CONNECTION_NAME=samaanai-stg-1009-124126:us-west1:samaanai-backend-staging-db
            ALLOWED_HOSTS=stg.trading.samaanai.com,trading-api-staging-362270100637.us-west1.run.app
            FRONTEND_URL=https://trading-dashboard-staging-362270100637.us-west1.run.app
            BROKER_TYPE=ibkr
            IBKR_GATEWAY_HOST=10.138.0.3
            IBKR_GATEWAY_PORT=4002
      
      - name: Run Django Migrations
        run: |
          BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE --region=$GCP_REGION --format='value(status.url)')
          echo "Backend URL: $BACKEND_URL"
          # Note: Migrations should be run as part of container startup or via a separate job
      
      - name: Show Backend URL
        run: |
          echo "✅ Backend deployed to: $(gcloud run services describe $BACKEND_SERVICE --region=$GCP_REGION --format='value(status.url)')"

  deploy-frontend:
    name: Deploy React Frontend
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker
      
      - name: Get Backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE --region=$GCP_REGION --format='value(status.url)')
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
      
      - name: Update API URL in Frontend
        working-directory: frontend
        run: |
          echo "REACT_APP_API_URL=${{ steps.backend-url.outputs.url }}" > .env.production
      
      - name: Build and Push Docker image
        working-directory: frontend
        run: |
          docker build -t gcr.io/$GCP_PROJECT/$FRONTEND_SERVICE:${{ github.sha }} .
          docker push gcr.io/$GCP_PROJECT/$FRONTEND_SERVICE:${{ github.sha }}
      
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.FRONTEND_SERVICE }}
          region: ${{ env.GCP_REGION }}
          image: gcr.io/${{ env.GCP_PROJECT }}/${{ env.FRONTEND_SERVICE }}:${{ github.sha }}
          flags: |
            --allow-unauthenticated
            --memory=256Mi
            --cpu=1
            --min-instances=0
            --max-instances=2
      
      - name: Show Frontend URL
        run: |
          echo "✅ Frontend deployed to: $(gcloud run services describe $FRONTEND_SERVICE --region=$GCP_REGION --format='value(status.url)')"
