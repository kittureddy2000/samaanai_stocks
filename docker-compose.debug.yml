services:
  # Local IB Gateway
  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:stable
    container_name: ib-gateway-debug
    env_file:
      - .env.debug
    environment:
      - TRADING_MODE=paper
      - VNC_PASSWORD=123456
      - EXISTING_SESSION_DETECTED_ACTION=primary
      - ACCEPT_INCOMING_CONNECTION=accept
      - TWOFA_TIMEOUT_ACTION=restart
      - READ_ONLY_API=no
      # IBC config setting to trust all Docker network IPs
      - IBC_TrustedTwsApiClientIPs=0.0.0.0/0
    ports:
      - "4002:4002" # API port
      - "4004:4004" # SOCAT forwarded port (accessible from Docker network)
      - "5900:5900" # VNC port for login
    restart: on-failure
    networks:
      - trading-net

  # Backend API
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: trading-backend-debug
    environment:
      - BROKER_TYPE=ibkr
      - IBKR_GATEWAY_HOST=ib-gateway
      - IBKR_GATEWAY_PORT=4004
      - IBKR_CLIENT_ID=1
      # Essential Django settings
      - DJANGO_SETTINGS_MODULE=backend.settings.development
      - DEBUG=True
      - DJANGO_SECRET_KEY=debug-secret
      # Mock other dependencies to avoid startup errors if not needed for this test
      - ALPACA_API_KEY=mock
      - ALPACA_SECRET_KEY=mock
      - DB_NAME=stock_trading
      - DB_USER=trading_user
      - DB_PASSWORD=trading_pass
    ports:
      - "8080:8080"
    volumes:
      - ./src:/app/src
    depends_on:
      - ib-gateway
    networks:
      - trading-net
    command: >
      sh -c "
        echo 'Waiting for IB Gateway...' &&
        sleep 20 &&
        python manage.py migrate --settings=backend.settings.development &&
        python manage.py runserver 0.0.0.0:8080
      "

networks:
  trading-net:
    driver: bridge
